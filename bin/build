#!/bin/bash
set -e

mkdir -p dist

commit=$(git rev-parse HEAD)

printf "\033[93mCompiling app/oligrapher.scss\033[0m\n"
npx sass app/oligrapher.scss dist/oligrapher.css

printf "\033[93mCompiling index.ts\033[0m\n"
npx esbuild \
    --bundle \
    --outfile=dist/oligrapher.js \
    --minify \
    --sourcemap \
    --target=firefox102,safari14,chrome104 \
    --define:API_URL='"https://littlesis.org"' \
    index.ts

printf "\033[94mMaking copies for $commit\033[0m\n"
cp dist/oligrapher.css dist/oligrapher-$commit.css
cp dist/oligrapher.css.map dist/oligrapher-$commit.css.map
cp dist/oligrapher.js dist/oligrapher-$commit.js
cp dist/oligrapher.js.map dist/oligrapher-$commit.js.map

printf "\033[93mCompressing...\033[0m\n"
find ./dist -type f -name "*oligrapher-$commit*" ! -name '*.gz' ! -name '*.br' -print0 |
    xargs -0 -P 4 -I FILE bash -c "gzip -f -k FILE && brotli -f -k FILE"


printf "Contents of dist/ "
ls -lh dist/
